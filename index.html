<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placar TV Imobili√°ria - Final V6</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* Estilos Globais */
        body { background-color: #0f172a; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Anima√ß√£o dos Slides */
        .slide { display: none; height: 100vh; width: 100vw; padding: 20px; box-sizing: border-box; animation: fadeUp 0.8s ease-in-out; }
        .active { display: flex; flex-direction: column; }
        @keyframes fadeUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
        
        /* --- AJUSTES DE LAYOUT P√ìDIO --- */
        .podium-container { display: flex; align-items: flex-end; justify-content: center; height: 100%; gap: 20px; }
        
        /* Barras */
        .podium-bar { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; border-radius: 12px 12px 0 0; width: 180px; position: relative; transition: height 1.5s cubic-bezier(0.4, 0, 0.2, 1); height: 0%; }
        
        .place-1 { background: linear-gradient(to top, #ca8a04, #facc15); border: 2px solid #fef08a; box-shadow: 0 0 50px rgba(250, 204, 21, 0.5); }
        .place-2 { background: linear-gradient(to top, #64748b, #94a3b8); border: 2px solid #e2e8f0; }
        .place-3 { background: linear-gradient(to top, #7c2d12, #d97706); border: 2px solid #fdba74; }
        
        /* Avatares - AGORA BEM MAIS ALTOS */
        .avatar { 
            width: 110px; height: 110px; 
            border-radius: 50%; border: 4px solid white; 
            /* Ajuste Cr√≠tico Aqui: */
            margin-bottom: -90px; 
            position: relative; 
            top: -90px; 
            /* ------------------ */
            z-index: 20; 
            background-color: #333; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); 
            background-size: cover; background-position: center; 
            transition: transform 0.5s; font-size: 3rem; 
        }
        .active .avatar { transform: scale(1.1); }
        
        /* Texto do P√≥dio - Padding extra no topo para garantir que o texto n√£o cole na borda */
        .podium-info { text-align: center; width: 100%; padding-top: 10px; padding-bottom: 10px; }

        /* Cart√µes KPI */
        .kpi-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; justify-content: center; border-left: 4px solid; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Gr√°ficos */
        .chart-container { position: relative; width: 100%; height: 100%; }
        
        /* Loading Overlay */
        #loading { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-slate-900">

    <div id="loading">
        <div class="text-6xl animate-bounce mb-4">üè†</div>
        <p class="text-blue-400 font-bold text-xl animate-pulse">Carregando Placar...</p>
    </div>

    <div id="slide1" class="slide active">
        <header class="h-[10%] flex items-center justify-center">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 uppercase tracking-widest drop-shadow-lg">üèÜ Ranking Geral</h1>
        </header>
        
        <div class="h-[40%] w-full mb-2 border-b border-slate-700/50 pb-2">
            <div class="podium-container">
                <div class="flex flex-col items-center">
                    <div class="avatar bg-gray-400" id="img-top2">üë§</div>
                    <div class="podium-bar place-2" id="bar-top2">
                        <div class="podium-info opacity-0 transition-opacity duration-1000 delay-500" id="info-top2">
                            <h2 class="text-4xl font-black text-slate-900 opacity-50">2¬∫</h2>
                            <p class="font-bold text-slate-900 text-2xl leading-tight mt-[-5px]" id="name-top2">...</p>
                            <span class="text-sm bg-slate-800 text-white px-3 py-1 rounded-full mt-2 inline-block font-bold" id="val-top2">R$ 0</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="avatar bg-yellow-400 ring-4 ring-yellow-500/50" id="img-top1">üëë</div>
                    <div class="podium-bar place-1" id="bar-top1">
                        <div class="podium-info opacity-0 transition-opacity duration-1000 delay-500" id="info-top1">
                            <h2 class="text-6xl font-black text-yellow-900 opacity-50">1¬∫</h2>
                            <p class="font-bold text-yellow-900 text-3xl leading-tight mt-[-10px]" id="name-top1">...</p>
                            <span class="text-lg bg-black text-yellow-400 px-4 py-2 rounded-full mt-3 inline-block font-bold" id="val-top1">R$ 0</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="avatar bg-orange-600" id="img-top3">üë§</div>
                    <div class="podium-bar place-3" id="bar-top3">
                        <div class="podium-info opacity-0 transition-opacity duration-1000 delay-500" id="info-top3">
                            <h2 class="text-4xl font-black text-orange-900 opacity-40">3¬∫</h2>
                            <p class="font-bold text-orange-100 text-2xl leading-tight mt-[-5px]" id="name-top3">...</p>
                            <span class="text-sm bg-orange-900 text-orange-100 px-3 py-1 rounded-full mt-2 inline-block font-bold" id="val-top3">R$ 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="h-[50%] grid grid-cols-2 gap-6 mt-1 pb-4">
            <div class="bg-slate-800/40 rounded-xl p-3 border border-slate-700 flex flex-col shadow-lg">
                <h3 class="text-lg font-bold text-slate-300 mb-1 border-b border-slate-700 pb-1">üìä Top 4+</h3>
                <div class="chart-container flex-grow"><canvas id="chartRankingRestante"></canvas></div>
            </div>
            <div class="bg-slate-800/40 rounded-xl p-3 border border-slate-700 flex flex-col shadow-lg">
                <h3 class="text-lg font-bold text-slate-300 mb-1 border-b border-slate-700 pb-1">üèòÔ∏è Top Captadores</h3>
                <div class="chart-container flex-grow"><canvas id="chartCaptacoes"></canvas></div>
            </div>
        </div>
    </div>

    <div id="slide2" class="slide">
        <header class="h-[10%] flex items-center justify-center">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-300 uppercase tracking-widest drop-shadow-lg">üìÖ Trimestre (Out/Nov/Dez)</h1>
        </header>
        <div class="grid grid-cols-12 gap-6 h-[88%] w-full">
            <div class="col-span-7 bg-slate-800/40 rounded-xl p-4 border border-slate-700 h-full flex flex-col shadow-lg">
                <h3 class="text-xl font-bold text-white mb-2">Ranking Trimestral</h3>
                <div class="chart-container flex-grow"><canvas id="chartTrimestreRanking"></canvas></div>
            </div>
            <div class="col-span-5 flex flex-col gap-4 h-full">
                <div class="grid grid-cols-2 gap-3 h-[35%]">
                    <div class="kpi-card border-l-blue-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Valor Geral de Venda</p>
                        <p class="text-xl font-bold text-white truncate" id="kpi-vgv">R$ 0</p>
                    </div>
                    <div class="kpi-card border-l-green-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Valor Real de Venda</p>
                        <p class="text-xl font-bold text-green-400 truncate" id="kpi-real">R$ 0</p>
                    </div>
                    <div class="kpi-card border-l-yellow-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Meta Trimestre</p>
                        <p class="text-xl font-bold text-yellow-400 truncate" id="kpi-meta">R$ 36.000.000</p>
                    </div>
                    <div class="kpi-card border-l-red-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Saldo Meta</p>
                        <p class="text-xl font-bold text-red-400 truncate" id="kpi-saldo">R$ 0</p>
                    </div>
                </div>
                <div class="bg-slate-800/40 rounded-xl p-4 border border-slate-700 flex-grow flex flex-col shadow-lg">
                    <h3 class="text-md font-bold text-slate-300 mb-1">Evolu√ß√£o Mensal</h3>
                    <div class="chart-container flex-grow"><canvas id="chartMesAMes"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="slide3" class="slide">
        <header class="h-[10%] flex items-center justify-center">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 uppercase tracking-widest drop-shadow-lg">‚öîÔ∏è Duelo de Equipes (Trimestre)</h1>
        </header>
        <div class="grid grid-cols-2 gap-8 h-[85%] w-full px-4">
            
            <div id="card-eq1" class="border rounded-2xl p-4 bg-gradient-to-b from-slate-800 to-slate-900 shadow-xl flex flex-col h-full transition-all">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-bold" id="nome-eq1">...</h2>
                    <span class="px-3 py-1 rounded text-sm font-bold bg-gray-700">L√≠der</span>
                </div>
                <div class="rounded-lg p-3 text-center mb-4 border border-gray-600 bg-gray-800/50">
                    <p class="text-xs uppercase tracking-wide opacity-70">VGV Trimestre</p>
                    <p class="text-3xl font-black text-white drop-shadow-md" id="total-eq1">R$ 0</p>
                </div>
                <div class="chart-container flex-grow"><canvas id="chartEquipeA"></canvas></div>
            </div>

            <div id="card-eq2" class="border rounded-2xl p-4 bg-gradient-to-b from-slate-800 to-slate-900 shadow-xl flex flex-col h-full transition-all">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-bold" id="nome-eq2">...</h2>
                    <span class="px-3 py-1 rounded text-sm font-bold bg-gray-700">2¬∫ Lugar</span>
                </div>
                <div class="rounded-lg p-3 text-center mb-4 border border-gray-600 bg-gray-800/50">
                    <p class="text-xs uppercase tracking-wide opacity-70">VGV Trimestre</p>
                    <p class="text-3xl font-black text-white drop-shadow-md" id="total-eq2">R$ 0</p>
                </div>
                <div class="chart-container flex-grow"><canvas id="chartEquipeB"></canvas></div>
            </div>

        </div>
    </div>

    <script>
        const GOOGLE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRb9rJ-bnHX7Pl-FiVgqeEptR8NX_F7kqu80Mpny5jCMIKUt8vYi7Zb4yYrIsIbPnz071ZgDSdfTy1K/pub?gid=828224418&single=true&output=csv'; 
        const URL_CSV = 'https://corsproxy.io/?' + encodeURIComponent(GOOGLE_CSV);
        const META_TRIMESTRAL = 36000000;
        
        function csvParaArray(strData, strDelimiter) {
            strDelimiter = (strDelimiter || ",");
            var objPattern = new RegExp(("(\\" + strDelimiter + "|\\r?\\n|\\r|^)" + "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" + "([^\"\\" + strDelimiter + "\\r\\n]*))"), "gi");
            var arrData = [[]];
            var arrMatches = null;
            while (arrMatches = objPattern.exec(strData)) {
                var strMatchedDelimiter = arrMatches[1];
                if (strMatchedDelimiter.length && strMatchedDelimiter !== strDelimiter) arrData.push([]);
                var strMatchedValue = arrMatches[2] ? arrMatches[2].replace(new RegExp("\"\"", "g"), "\"") : arrMatches[3];
                arrData[arrData.length - 1].push(strMatchedValue);
            }
            return arrData;
        }

        const parseMoney = (str) => {
            if (!str) return 0;
            let clean = str.replace(/[R$\s]/g, '').replaceAll('.', '').replace(',', '.');
            return parseFloat(clean) || 0;
        };

        const formatMoney = (val) => {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
        };

        async function carregarDados() {
            try {
                const response = await fetch(URL_CSV);
                if (!response.ok) throw new Error("Status: " + response.status);
                
                const text = await response.text();
                const rows = csvParaArray(text, ",");
                
                let vendasTrimestre = [];
                let vendasMesAMes = { '10': 0, '11': 0, '12': 0 };
                let corretores = {};
                let captadores = {};
                let equipes = {};
                let totalTrimValorReal = 0;
                let totalTrimVGV = 0;

                for (let i = 1; i < rows.length; i++) {
                    const col = rows[i];
                    if (!col || col.length < 5) continue; 

                    const strData = col[1] || "";
                    const dataParts = strData.split('/'); 
                    if(dataParts.length !== 3) continue; 
                    
                    const mes = parseInt(dataParts[1]);
                    const ano = parseInt(dataParts[2]);

                    const vgv = parseMoney(col[2]); 
                    const valorReal = parseMoney(col[3]);
                    const corretor = col[6] ? col[6].trim() : "Desconhecido"; 
                    const captador = col[7] ? col[7].trim() : "";
                    const equipe = col[16] ? col[16].trim() : 'Geral';
                    const foto = col[17] ? col[17].trim() : '';

                    // FILTRO GERAL
                    if (corretor === "Lauro Braga") continue;

                    if (ano === 2025 || ano === 2024) { 
                        // Ranking Geral
                        if (!corretores[corretor]) corretores[corretor] = { nome: corretor, vgv: 0, foto: foto, equipe: equipe };
                        corretores[corretor].vgv += vgv;

                        // Captadores
                        if (captador && captador !== '-' && captador.length > 2 && captador !== "Lauro Braga") {
                            if (!captadores[captador]) captadores[captador] = 0;
                            captadores[captador]++;
                        }

                        // Trimestre
                        if (mes >= 10 && mes <= 12) {
                            vendasTrimestre.push({ corretor, vgv });
                            vendasMesAMes[mes] += vgv;
                            totalTrimVGV += vgv;
                            totalTrimValorReal += valorReal;

                            if (!equipes[equipe]) equipes[equipe] = { nome: equipe, vgv: 0, corretores: {} };
                            equipes[equipe].vgv += vgv;
                            if (!equipes[equipe].corretores[corretor]) equipes[equipe].corretores[corretor] = 0;
                            equipes[equipe].corretores[corretor] += vgv;
                        }
                    }
                }

                atualizarInterface(corretores, captadores, equipes, vendasTrimestre, vendasMesAMes, totalTrimVGV, totalTrimValorReal);
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => document.getElementById('loading').style.display = 'none', 500);

            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = `<div class="bg-red-900 p-6 rounded-xl border border-red-500 text-center"><h2 class="text-3xl mb-2">‚ö†Ô∏è Erro</h2><p>${error.message}</p></div>`;
            }
        }

        function atualizarInterface(corretores, captadores, equipes, vendasTrimestre, vendasMesAMes, totalTrimVGV, totalTrimValorReal) {
            
            // 1. ANUAL
            const rankingAnual = Object.values(corretores).sort((a,b) => b.vgv - a.vgv);
            
            const updatePodium = (rank, prefix, heightClass) => {
                if(rankingAnual[rank]) {
                    document.getElementById(`name-${prefix}`).innerText = rankingAnual[rank].nome;
                    document.getElementById(`val-${prefix}`).innerText = formatMoney(rankingAnual[rank].vgv);
                    if(rankingAnual[rank].foto) {
                        document.getElementById(`img-${prefix}`).innerText = '';
                        document.getElementById(`img-${prefix}`).style.backgroundImage = `url('${rankingAnual[rank].foto}')`;
                    }
                    document.querySelector(`.${heightClass}`).style.height = heightClass === 'place-1' ? '85%' : (heightClass === 'place-2' ? '65%' : '50%');
                    document.getElementById(`info-${prefix}`).style.opacity = '1';
                }
            };
            updatePodium(0, 'top1', 'place-1');
            updatePodium(1, 'top2', 'place-2');
            updatePodium(2, 'top3', 'place-3');

            const top4to8 = rankingAnual.slice(3, 8);
            chartRankingRestante.data.labels = top4to8.map((c, i) => `${i+4}¬∫ ${c.nome}`);
            chartRankingRestante.data.datasets[0].data = top4to8.map(c => c.vgv);
            chartRankingRestante.update();

            const rankingCaptadores = Object.entries(captadores).map(([n,q]) => ({n,q})).sort((a,b) => b.q - a.q).slice(0, 5);
            chartCaptacoes.data.labels = rankingCaptadores.map(c => c.n);
            chartCaptacoes.data.datasets[0].data = rankingCaptadores.map(c => c.q);
            chartCaptacoes.update();

            // 2. TRIMESTRE
            let trimByCorretor = {};
            vendasTrimestre.forEach(v => {
                if(!trimByCorretor[v.corretor]) trimByCorretor[v.corretor] = 0;
                trimByCorretor[v.corretor] += v.vgv;
            });

            document.getElementById('kpi-vgv').innerText = formatMoney(totalTrimVGV);
            document.getElementById('kpi-real').innerText = formatMoney(totalTrimValorReal);
            
            const saldo = totalTrimVGV - META_TRIMESTRAL;
            const elSaldo = document.getElementById('kpi-saldo');
            elSaldo.innerText = formatMoney(saldo);
            elSaldo.className = `text-xl font-bold truncate ${saldo >= 0 ? 'text-green-400' : 'text-red-400'}`;
            if(saldo > 0) elSaldo.innerText = "+" + elSaldo.innerText;

            const rankingTrim = Object.entries(trimByCorretor).map(([n,v])=>({n,v})).sort((a,b)=>b.v - a.v).slice(0, 7);
            chartTrimestre.data.labels = rankingTrim.map(c => c.n);
            chartTrimestre.data.datasets[0].data = rankingTrim.map(c => c.v);
            chartTrimestre.update();

            chartMes.data.datasets[0].data = [vendasMesAMes['10'], vendasMesAMes['11'], vendasMesAMes['12']];
            chartMes.update();

            // 3. EQUIPES
            const eqRaphael = equipes["Time Raphael"] || { nome: "Time Raphael", vgv: 0, corretores: {} };
            const eqFelipe = equipes["Time Felipe"] || { nome: "Time Felipe", vgv: 0, corretores: {} };
            
            const times = [eqRaphael, eqFelipe].sort((a,b) => b.vgv - a.vgv);
            const winner = times[0];
            const loser = times[1];

            const card1 = document.getElementById('card-eq1');
            const card2 = document.getElementById('card-eq2');

            card1.className = "border-2 border-green-500/50 rounded-2xl p-4 bg-gradient-to-b from-slate-800 to-green-900/20 shadow-[0_0_30px_rgba(16,185,129,0.2)] flex flex-col h-full";
            document.getElementById('nome-eq1').className = "text-2xl font-bold text-green-400";
            
            card2.className = "border border-blue-600/50 rounded-2xl p-4 bg-gradient-to-b from-slate-800 to-slate-900 flex flex-col h-full opacity-90";
            document.getElementById('nome-eq2').className = "text-2xl font-bold text-blue-400";

            updateTeamData(winner, chartEqA, 'eq1', '#10b981'); 
            updateTeamData(loser, chartEqB, 'eq2', '#3b82f6'); 
        }

        function updateTeamData(eq, chartObj, prefix, color) {
            document.getElementById(`nome-${prefix}`).innerText = eq.nome;
            document.getElementById(`total-${prefix}`).innerText = formatMoney(eq.vgv);
            
            const rankEq = Object.entries(eq.corretores).map(([n,v])=>({n,v})).sort((a,b)=>b.v - a.v).slice(0,4);
            
            chartObj.data.labels = rankEq.map(c => c.n);
            chartObj.data.datasets[0].data = rankEq.map(c => c.v);
            chartObj.data.datasets[0].backgroundColor = color;
            chartObj.update();
        }

        const commonOptions = {
            indexAxis: 'y', maintainAspectRatio: false, responsive: true,
            layout: { padding: { right: 20 } },
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    color: 'white', 
                    anchor: 'end', 
                    align: 'start', 
                    clamp: true, 
                    formatter: (val) => val.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0}), 
                    font: {weight:'bold'} 
                } 
            },
            scales: { x: { grid: { color: '#334155' } }, y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: {size: 13} } } }
        };

        let chartRankingRestante = new Chart(document.getElementById('chartRankingRestante'), { type: 'bar', plugins: [ChartDataLabels], data: { labels: [], datasets: [{ data: [], backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: commonOptions });
        let chartCaptacoes = new Chart(document.getElementById('chartCaptacoes'), { type: 'bar', plugins: [ChartDataLabels], data: { labels: [], datasets: [{ data: [], backgroundColor: '#10b981', borderRadius: 4 }] }, options: { ...commonOptions, plugins: { ...commonOptions.plugins, datalabels: { ...commonOptions.plugins.datalabels, formatter: (v) => v } } } });
        let chartTrimestre = new Chart(document.getElementById('chartTrimestreRanking'), { type: 'bar', plugins: [ChartDataLabels], data: { labels: [], datasets: [{ data: [], backgroundColor: (ctx) => ctx.dataIndex===0 ? '#facc15' : '#3b82f6', borderRadius: 4 }] }, options: commonOptions });
        
        let chartMes = new Chart(document.getElementById('chartMesAMes'), { 
            type: 'bar', 
            plugins: [ChartDataLabels],
            data: { 
                labels: ['Outubro', 'Novembro', 'Dezembro'], 
                datasets: [ { label: 'Realizado', data: [0, 0, 0], backgroundColor: '#6366f1', borderRadius: 4 } ] 
            }, 
            options: { 
                maintainAspectRatio: false, 
                plugins: {
                    legend: { display: false }, 
                    datalabels: { color: 'white', anchor: 'end', align: 'end', formatter: (val) => formatMoney(val), font: { weight: 'bold' } }
                },
                scales: { y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { display: false } }, x: { grid: { display: false } } } 
            } 
        });

        let chartEqA = new Chart(document.getElementById('chartEquipeA'), { type: 'bar', plugins: [ChartDataLabels], data: { labels: [], datasets: [{ data: [], backgroundColor: '#3b82f6' }] }, options: commonOptions });
        let chartEqB = new Chart(document.getElementById('chartEquipeB'), { type: 'bar', plugins: [ChartDataLabels], data: { labels: [], datasets: [{ data: [], backgroundColor: '#ef4444' }] }, options: commonOptions });

        let currentSlide = 1;
        setInterval(() => {
            document.querySelectorAll('.slide').forEach(el => el.classList.remove('active'));
            currentSlide++;
            if (currentSlide > 3) currentSlide = 1;
            document.getElementById(`slide${currentSlide}`).classList.add('active');
        }, 30000);

        carregarDados();
        setInterval(carregarDados, 120000);
    </script>
</body>

</html>

